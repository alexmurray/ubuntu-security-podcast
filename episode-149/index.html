<!DOCTYPE html>
<html itemscope lang="en-us">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="description" content="  This week Qualys dominate the week in security updates, disclosing details
  of 4 different SUID-root vulnerabilities, including Oh Snap! More Lemmings
  (Local Privilege Escalation in snap-confine), plus we look at updates for
  Firefox, cryptsetup and more.
  ">

<meta name="generator" content="Hugo 0.130.0">

<meta property="og:title" content="Episode 149" />
<meta name="twitter:title" content="Episode 149"/>
<meta itemprop="name" content="Episode 149">
<meta property="article:published_time" content="2022-02-18T16:51:00&#43;10:30" />
<meta property="article:modified_time" content="2022-05-15T18:05:43&#43;09:30" />
<meta property="og:updated_time" content="2022-05-15T18:05:43&#43;09:30" /><meta property="og:site_name" content="Ubuntu Security Podcast" /><meta property="og:description" content="  This week Qualys dominate the week in security updates, disclosing details
  of 4 different SUID-root vulnerabilities, including Oh Snap! More Lemmings
  (Local Privilege Escalation in snap-confine), plus we look at updates for
  Firefox, cryptsetup and more.
  " />
    <meta name="twitter:description" content="  This week Qualys dominate the week in security updates, disclosing details
  of 4 different SUID-root vulnerabilities, including Oh Snap! More Lemmings
  (Local Privilege Escalation in snap-confine), plus we look at updates for
  Firefox, cryptsetup and more.
  " />
    <meta itemprop="description" content="  This week Qualys dominate the week in security updates, disclosing details
  of 4 different SUID-root vulnerabilities, including Oh Snap! More Lemmings
  (Local Privilege Escalation in snap-confine), plus we look at updates for
  Firefox, cryptsetup and more.
  ">

  
    <meta name="twitter:site" content="@ubuntu_sec"/>
    <meta name="twitter:creator" content="@ubuntu_sec"/>
  

<meta name="twitter:domain" content="ubuntu.com"/>

<meta property="og:type" content="article" />
<meta property="og:url" content="/episode-149/" />




<title>Episode 149</title>
<link rel="canonical" href="https://ubuntusecuritypodcast.org/episode-149/">







<link rel="icon" href="https://ubuntusecuritypodcast.org/img/usp_logo_32.png">









<link href="https://ubuntusecuritypodcast.org/css/ubuntu.css" rel="stylesheet">

<link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">


<link href=https://ubuntusecuritypodcast.org/css/all.css rel="stylesheet">
<link href=https://ubuntusecuritypodcast.org/css/mediaelementplayer.min.css rel="stylesheet">
<style>
    .mejs__overlay-button {
        background-image: url("/img/mejs-controls.svg");
    }
    .mejs__overlay-loading-bg-img {
        background-image: url("/img/mejs-controls.svg");
    }
    .mejs__button > button {
        background-image: url("/img/mejs-controls.svg");
    }
    </style>
<link href=https://ubuntusecuritypodcast.org/css/speed.min.css rel="stylesheet">
<link rel="alternate" type="application/rss+xml" title="Ubuntu Security Podcast" href="https://ubuntusecuritypodcast.org/episode/index.xml"/>

</head>

<body lang="">
<nav class="navbar fixed-top navbar-expand-md navbar-light bg-light">
<div class="container">
<a class="navbar-brand" href="https://ubuntusecuritypodcast.org/">Ubuntu Security Podcast</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div id="navbarSupportedContent" class="navbar-collapse collapse">
      <ul class="navbar-nav mr-auto">
          
          
            
              
                  <li class= "nav-item ">
                  <a href="https://ubuntusecuritypodcast.org/about/" class="nav-link">
                      
                      <span>About</span>
                  </a>
                </li>
              
            
              
                  <li class= "nav-item ">
                  <a href="https://ubuntusecuritypodcast.org/contact/" class="nav-link">
                      
                      <span>Contact</span>
                  </a>
                </li>
              
            
          
        </ul>

      <ul class="navbar-nav ml-auto">
        
        
          <li>
            

  <a class="social-links" href = "https://twitter.com/ubuntu_sec"><i class="fab fa-twitter-square fa-2x"></i></a>


          </li>
        
        
        
        
        
        
        
        
        
        <li>
          

  <a class="social-links" href = "https://fosstodon.org/@ubuntusecurity"><i class="fab fa-mastodon fa-2x"></i></a>


        </li>
        
      </ul>
  </div>
  </div>
  </nav>

<div class="container middle_container">
  

  <div class="row">
    <div class="col">      
      
        <h1>Episode 149</h1>
      <small>Posted on Friday, Feb 18, 2022 


</small></div>
  </div>

  
    <div class="row">
          <div class="col-md-3">
            <img src="https://ubuntusecuritypodcast.org/img/usp_logo_500.png" class="img-fluid episode_image"/>
          </div>
          <div class="col-md-8">
            This week Qualys dominate the week in security updates, disclosing details
of 4 different SUID-root vulnerabilities, including Oh Snap! More Lemmings
(Local Privilege Escalation in snap-confine), plus we look at updates for
Firefox, cryptsetup and more.
          </div>
        </div>
    <div class="row">
          <div class="col-md-12 player_row">

          <audio id="player2" style="width: 100%" controls preload="none">
            <source src="https://people.canonical.com/~amurray/USP/USP_E149.mp3" type="audio/mp3">
            </audio>
          </div>
        </div>

  <div class="row">
    <div class="col">
      <h2>Show Notes</h2>
      <h2 id="overview">Overview</h2>
<p>This week Qualys dominate the week in security updates, disclosing details
of 4 different SUID-root vulnerabilities, including Oh Snap! More Lemmings
(Local Privilege Escalation in snap-confine), plus we look at updates for
Firefox, cryptsetup and more.</p>
<h2 id="this-week-in-ubuntu-security-updates">This week in Ubuntu Security Updates</h2>
<p>23 unique CVEs addressed</p>
<h3 id="usn-5279-1-util-linux-vulnerabilities-00-59">[<a href="https://ubuntu.com/security/notices/USN-5279-1">USN-5279-1</a>] util-linux vulnerabilities [00:59]</h3>
<ul>
<li>2 CVEs addressed in Focal (20.04 LTS), Impish (21.10)
<ul>
<li><a href="https://ubuntu.com/security/CVE-2021-3996">CVE-2021-3996</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2021-3995">CVE-2021-3995</a> <!-- raw HTML omitted --></li>
</ul>
</li>
<li>First 2 of number of vulns discovered by Qualys this week</li>
<li>umount and fusermount are both setuid root</li>
<li>An unprivileged user is allowed to unmount a FUSE filesystem which is
already mounted and which they own</li>
<li>libumount parses <code>/proc/self/mountinfo</code> to validate if is a FUSE fs</li>
<li>When a mount entry is deleted, the kernel appends <code>(deleted)</code> to the name
of it in the mount table</li>
<li>libumount strips this off when parsing <code>mountinfo</code> to get the actual path</li>
<li>so a user could mount a FUSE filesystem at a mountpoint with <code>(deleted)</code> in
the name - and then libumount will strip this off and umount the original
path - ie. could mount at <code>/tmp/ (deleted)</code> then call <code>umount /tmp</code> and this
will succeed</li>
<li>Fixed to drop support for this <code>(deleted)</code> suffix as this has not been used
by the kernel since December 2014</li>
<li>Also when checking the UID of the user (as the owner of the filesystem),
would do a string comparison on the UID of the user against the UID of
the filesystem - but would use the length of the users UID to do this
comparison - which means a user UID of 1000 would then be seen to match
against a file-systems UID of 10000 etc - so would allow a user to umount
filesystems owned by certain other users</li>
<li>Fixed to compare as a numerical value rather than strings</li>
</ul>
<h3 id="usn-5280-1-speex-vulnerability-04-41">[<a href="https://ubuntu.com/security/notices/USN-5280-1">USN-5280-1</a>] Speex vulnerability [04:41]</h3>
<ul>
<li>1 CVEs addressed in Xenial ESM (16.04 ESM), Bionic (18.04 LTS), Focal (20.04 LTS), Impish (21.10)
<ul>
<li><a href="https://ubuntu.com/security/CVE-2020-23903">CVE-2020-23903</a> <!-- raw HTML omitted --></li>
</ul>
</li>
<li>Divide by zero from a crafted WAV file - trap - crash - DoS</li>
</ul>
<h3 id="usn-5284-1-firefox-vulnerabilities-04-56">[<a href="https://ubuntu.com/security/notices/USN-5284-1">USN-5284-1</a>] Firefox vulnerabilities [04:56]</h3>
<ul>
<li>9 CVEs addressed in Bionic (18.04 LTS), Focal (20.04 LTS), Impish (21.10)
<ul>
<li><a href="https://ubuntu.com/security/CVE-2022-22757">CVE-2022-22757</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2022-22756">CVE-2022-22756</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2022-22754">CVE-2022-22754</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2022-22764">CVE-2022-22764</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2022-22761">CVE-2022-22761</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2022-22760">CVE-2022-22760</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2022-22759">CVE-2022-22759</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2022-22755">CVE-2022-22755</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2022-0511">CVE-2022-0511</a> <!-- raw HTML omitted --></li>
</ul>
</li>
<li>97.0</li>
<li>Extensions could bypass update prompt and auto-update itself with extra
permissions</li>
<li>Drag and drop of a crafted image would make the resulting file
executable - could possibly use as RCE</li>
<li>WebDriver (remote control interface for firefox) failed to validate
Host/Origin headers - if visit malicious website with WebDriver enabled
could then allow attacker to connect back to the user&rsquo;s browser and take
control of it</li>
</ul>
<h3 id="usn-5286-1-cryptsetup-vulnerability-06-20">[<a href="https://ubuntu.com/security/notices/USN-5286-1">USN-5286-1</a>] cryptsetup vulnerability [06:20]</h3>
<ul>
<li>1 CVEs addressed in Focal (20.04 LTS), Impish (21.10)
<ul>
<li><a href="https://ubuntu.com/security/CVE-2021-4122">CVE-2021-4122</a> <!-- raw HTML omitted --></li>
</ul>
</li>
<li>Failed to properly validate the device header - local attacker with
physical access could modify this to trick cryptsetup to reencrypt the
device on next mount - but reencrypt it with no encryption enabled -
ie. decrypt it in place</li>
<li>Fixed by disabling the online reencryption feature</li>
</ul>
<h3 id="usn-5267-3-linux-kernel--raspberry-pi--vulnerabilities-07-11">[<a href="https://ubuntu.com/security/notices/USN-5267-3">USN-5267-3</a>] Linux kernel (Raspberry Pi) vulnerabilities [07:11]</h3>
<ul>
<li>3 CVEs addressed in Bionic (18.04 LTS), Focal (20.04 LTS)
<ul>
<li><a href="https://ubuntu.com/security/CVE-2021-42739">CVE-2021-42739</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2021-3752">CVE-2021-3752</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2021-3640">CVE-2021-3640</a> <!-- raw HTML omitted --></li>
</ul>
</li>
<li><a href="https://ubuntusecuritypodcast.org/episode-148/">Episode 148</a> - 2 vulns in bluetooth and one in Firewire subsystems - local
attacker crash / RCE - corresponding fixes for RPi on 20.04 or 18.04 with
HWE</li>
</ul>
<h3 id="usn-5291-1-libarchive-vulnerabilities-07-36">[<a href="https://ubuntu.com/security/notices/USN-5291-1">USN-5291-1</a>] libarchive vulnerabilities [07:36]</h3>
<ul>
<li>3 CVEs addressed in Focal (20.04 LTS), Impish (21.10)
<ul>
<li><a href="https://ubuntu.com/security/CVE-2021-36976">CVE-2021-36976</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2021-31566">CVE-2021-31566</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2021-23177">CVE-2021-23177</a> <!-- raw HTML omitted --></li>
</ul>
</li>
<li>2 issues in symlink handling - would follow symlinks when changing
modes/times/ACLs on files when extracting a crafted archive - could allow
an attacker to modify these attributes on files outside of the archive</li>
<li>Memory corruption when parsing RAR archive - DoS/RCE</li>
</ul>
<h3 id="usn-5292-1-snapd-vulnerabilities-08-27">[<a href="https://ubuntu.com/security/notices/USN-5292-1">USN-5292-1</a>] snapd vulnerabilities [08:27]</h3>
<ul>
<li>4 CVEs addressed in Bionic (18.04 LTS), Focal (20.04 LTS), Impish (21.10)
<ul>
<li><a href="https://ubuntu.com/security/CVE-2021-44731">CVE-2021-44731</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2021-44730">CVE-2021-44730</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2021-4120">CVE-2021-4120</a> <!-- raw HTML omitted --></li>
<li><a href="https://ubuntu.com/security/CVE-2021-3155">CVE-2021-3155</a> <!-- raw HTML omitted --></li>
</ul>
</li>
<li>More Qualys issues in setuid root binary - snap-confine - plus 2 issues
discovered by Canonical - 1 from Ian Johnson of the snapd team, and 1
from James Troup of the BootStack team</li>
</ul>
<h2 id="oh-snap-more-lemmings--local-privilege-escalation-in-snap-confine--09-01">Oh Snap! More Lemmings (Local Privilege Escalation in snap-confine) [09:01]</h2>
<ul>
<li>
<p><a href="https://www.qualys.com/2022/02/17/cve-2021-44731/oh-snap-more-lemmings.txt">https://www.qualys.com/2022/02/17/cve-2021-44731/oh-snap-more-lemmings.txt</a></p>
</li>
<li>
<p>Qualys appear to have been auditing various SUID-root binaries - recently
looked at snap-confine - low-level application, written in C, and used by
snapd to setup the execution environment for a snap application - as the
name suggests, it setups up the confinement for an application, creating
a separate mount namespace with own private <code>/tmp</code> and <code>/dev/pts</code> - as well
as any other mounts through content interfaces or layouts etc defined by
the snap, plus loading of seccomp syscall filters for the resulting snap</p>
</li>
<li>
<p>As such requires root privileges, hence is SUID-root - high value target</p>
</li>
<li>
<p>Very defensively programmed itself, plus is confined by seccomp and
AppArmor itself</p>
</li>
<li>
<p>Nonetheless, even the most carefully programmed software can have issues</p>
</li>
<li>
<p>2 vulns:</p>
<ul>
<li>hardlink attack (requires a non-standard configuration where system
admin disabled usual hardlink protections)</li>
<li>race-condition when creating mount namespace - allows an unprivileged
user to inject their own malicious libraries into the snap execution
environment and have these get executed by snap-confine itself to gain
root privesc</li>
</ul>
</li>
<li>
<p>Qualys liken these vulnerabilities (or the process to finding them) as
like playing the original Lemmings game, due to the complex nature of
steps required to thwart the defense-in-depth construction of
snap-confine</p>
</li>
<li>
<p>Not the first time snap-confine has been audited - SuSE Security Team
previously audited it in 2019 and found a couple issues, in particular in
some of the same code sections as these</p>
</li>
<li>
<p>Back to these vulns:</p>
<ul>
<li>
<p>When creating or deleting the mount namespace, snap-confine uses 2
helper programs written in Go - these are installed in the same
location as snap-confine, so it looks them up from the same directory
where it is running itself - however, since (when <code>protected_hardlinks</code>
is disabled) an unprivileged user could hardlink snap-confine into say
<code>/tmp</code> they could also then place their own malicious binary in place of
these helpers and have that get executed by snap-confine instead</p>
</li>
<li>
<p>NOTE: <code>protected_hardlinks</code> is enabled by default on almost all distros
so unless this has been changed by the system admin, this is unable to
be exploited in reality</p>
</li>
<li>
<p>Other vuln is a race condition when creating the private mount
namespace for the snap - snap-confine creates a per-snap private
directory under <code>/tmp</code> - this is a known &ldquo;dangerous&rdquo; thing to do since
<code>/tmp</code> is world writable so users could easily try and symlink their own
contents into it etc</p>
</li>
<li>
<p>snap-confine is very careful then to try and ensure this directory is
owned by root and to then avoid following symlinks when traversing this
hierarchy etc</p>
</li>
<li>
<p>However, when then doing the actual <code>mount()</code> syscall to start setting up
the mount namespace inside this directory, the absolute path of this
directory is given to <code>mount()</code> (since sadly there is no <code>mountat()</code> or
similar syscall) - which then <strong>does</strong> follow symlinks allowing a user who
an race the creation of this directory with snap-confine to be able to
take control of the contents of it, and hence inject their own
libraries and configuration such that a malicious library can be
preloaded into a subsequent execution of snap-confine - and since
snap-confine will then still run as root, this allows to get root code
execution</p>
</li>
</ul>
</li>
<li>
<p>In both cases, the use of AppArmor by default tries to isolate
snap-confine - and snap-confine is programmed defensively such that it
will refuse to execute if it is not confined by AppArmor - however, the
checks for this were not strict enough, and Qualys found they could use
<code>aa-exec</code> to execute snap-confine under a separate, more permissive
AppArmor profile to escape these restrictions</p>
</li>
<li>
<p>Fixes for these issues were numerous - to both add additional hardening
to snap-confine so that it would validate the AppArmor profile it
executes under is the one that is expected - plus the actual fixes for
the vulnerabilities themselves, by checking <code>snap-confine</code> is located where
it expects to be (so it doesn&rsquo;t execute other arbitrary helpers), and to
also when setting up the mount namespace directory hierarchy, forcefully
try and move aside any existing parts that are not root owned so it can
create them afresh with known ownership/permissions so that unprivileged
users can&rsquo;t trick it with their own contents</p>
</li>
<li>
<p>As mentioned, also includes fixes for 2 other issues identified by
Canonical - open permissions on snap per-user HOME/private storage allows
other users to potentially access private info stored by snaps</p>
</li>
<li>
<p>Plus a more sinister issue in the handling of AppArmor rules for snaps</p>
</li>
<li>
<p>A snap can define a content interface - way of making files available to
other snaps - snaps can then connect to this to access that content -
often used to implement plugins or other such concepts between snaps</p>
</li>
<li>
<p>When creating an AppArmor profile for a snap, adds additional rules then
to allow access to these paths within the other snap</p>
</li>
<li>
<p>Included code to validate that a snap wasn&rsquo;t trying to expose content it
shouldn&rsquo;t BUT didn&rsquo;t validate that these were just paths and nothing else</p>
</li>
<li>
<p>Since AppArmor policy is human-readable text files, these get generated
by snapd by adding the content interface paths into the policy</p>
</li>
<li>
<p>Content interface path could then contain additional AppArmor policy
directives and these would get included in the generated profile</p>
</li>
<li>
<p>Since any snap can specify content interfaces, and they get
auto-connected by snaps from the same publisher, would then just have to
get a user to install 2 malicious snaps from the same publisher where one
declares a malicious interface like this and then the snaps will be able
to escape the usual strict confinement provided by AppArmor</p>
</li>
<li>
<p>Fixed in snapd to both validate paths more correctly, and to also quote
all file-system paths in the generated AppArmor policies so that
arbitrary rules cannot be specified</p>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>Shows that the defence-in-depth approach is still worthwhile - Qualys
mentions they nearly gave up looking for vulns and then on trying to
exploit them due to just how hard the task appeared given all the
defensive measures they would have to overcome</p>
</li>
<li>
<p>Want to thank Qualys for all their efforts in disclosing vulns and in
providing feedback on proposed fixes etc, and the snapd team for all
their help on finding and remediating the vulnerability with content
interface / layout paths, plus on preparing and delivering this update</p>
</li>
<li>
<p>Has been in the works for a while, glad it is finally out</p>
</li>
</ul>
<h2 id="get-in-contact">Get in contact</h2>
<ul>
<li><a href="mailto:security@ubuntu.com">security@ubuntu.com</a></li>
<li><a href="https://libera.chat">#ubuntu-security on the Libera.Chat IRC network</a></li>
<li><a href="https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened">ubuntu-hardened mailing list</a></li>
<li><a href="https://discourse.ubuntu.com/c/security">Security section on discourse.ubuntu.com</a></li>
<li><a href="https://twitter.com/ubuntu_sec">@ubuntu_sec on twitter</a></li>
</ul>

    </div>
  </div>



  

  


      <div class="row">
        
        <div class="col-md-12">
          <div id="share"></div>
        </div>
      </div>
      
      
      
      

      <div class="row">
        
        <div class="col-md-12">
          <nav>
            <ul class="pagination">
              
                <li class="page-item">
                  <a href="https://ubuntusecuritypodcast.org/episode-148/" class="page-link">
                    <span aria-hidden="true">&larr;</span>
                    Previous</a>
                </li>
                
              
                <li class="page-item">
                  <a href="https://ubuntusecuritypodcast.org/episode-150/" class="page-link">Next
                    <span aria-hidden="true">&rarr;</span>
                  </a>
                </li>
                
            </ul>
          </nav>
        </div>
      </div>
      
    
</div> 
<div class = "container bottom_container">
  <div class="row">
  <div class="col-md-12">
    <nav class = "navbar navbar-default navbar_footer">
    <ul class="nav navbar-nav navbar-right">
      
        <li>
          <p class = "footer_copyright">Copyright 2018-2024 <a href="https://www.canonical.com/">Canonical</a></p>
        </li>
      
      <li>
        &nbsp;
      </li>
    </ul>
  </nav>

  </div>
</div>
</div>
<script src='https://ubuntusecuritypodcast.org/js/castanet-min.js'></script>
<script>
  $("#share").jsSocials({
      shares: [
    {
      share: "facebook",
      logo: "fab fa-facebook",
    },
    {
      share: "twitter",           
      label: "Tweet",             
      logo: "fab fa-twitter",
      
      
      
      
      
        
          via: "ubuntu_sec", 
        
      
      url: "https:\/\/ubuntusecuritypodcast.org\/episode-149\/",
      text: "Episode 149"
    },
    {
      share: "linkedin",
      logo: "fab fa-linkedin"
    },
    {
      share: "pinterest",
      logo: "fab fa-pinterest"
    }
  ],
  });
</script>

<script>
    $(document).ready(function() {

        $('.transcript').hide();
        $(".hide_transcript").hide();
        $(".hide_transcript").click(function() {
            $(".transcript").hide("fast");
            $(".show_transcript").show();
            $(".hide_transcript").hide();
        });

        $(".show_transcript").click(function() {
            $(".transcript").show(500);
            $(".hide_transcript").show();
            $(".show_transcript").hide();
        });

    });
</script>

<script>
    var player = new MediaElementPlayer('player2', {
        features: ['playpause', 'current', 'progress', 'duration', 'volume', 'speed'],
        defaultSpeed: 1.0,
        
    });
</script>

</body>
</html>

