<!DOCTYPE html>
<html itemscope lang="en-us">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="description" content="  This week we dive into the details of a number of local privilege escalation
  vulnerablities discovered by Qualys in the needrestart package, covering topics
  from confused deputies to the inner workings of the /proc filesystem and
  responsible disclosure as well.
  ">

<meta name="generator" content="Hugo 0.139.2">

<meta property="og:title" content="Episode 242" />
<meta name="twitter:title" content="Episode 242"/>
<meta itemprop="name" content="Episode 242">
<meta property="article:published_time" content="2024-11-29T11:54:00&#43;10:30" />
<meta property="article:modified_time" content="2024-11-29T11:56:46&#43;10:30" />
<meta property="og:updated_time" content="2024-11-29T11:56:46&#43;10:30" /><meta property="og:site_name" content="Ubuntu Security Podcast" /><meta property="og:description" content="  This week we dive into the details of a number of local privilege escalation
  vulnerablities discovered by Qualys in the needrestart package, covering topics
  from confused deputies to the inner workings of the /proc filesystem and
  responsible disclosure as well.
  " />
    <meta name="twitter:description" content="  This week we dive into the details of a number of local privilege escalation
  vulnerablities discovered by Qualys in the needrestart package, covering topics
  from confused deputies to the inner workings of the /proc filesystem and
  responsible disclosure as well.
  " />
    <meta itemprop="description" content="  This week we dive into the details of a number of local privilege escalation
  vulnerablities discovered by Qualys in the needrestart package, covering topics
  from confused deputies to the inner workings of the /proc filesystem and
  responsible disclosure as well.
  ">

  
    <meta name="twitter:site" content="@ubuntu_sec"/>
    <meta name="twitter:creator" content="@ubuntu_sec"/>
  

<meta name="twitter:domain" content="ubuntu.com"/>

<meta property="og:type" content="article" />
<meta property="og:url" content="/episode-242/" />




<title>Episode 242</title>
<link rel="canonical" href="https://ubuntusecuritypodcast.org/episode-242/">







<link rel="icon" href="https://ubuntusecuritypodcast.org/img/usp_logo_32.png">









<link href="https://ubuntusecuritypodcast.org/css/ubuntu.css" rel="stylesheet">

<link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">


<link href=https://ubuntusecuritypodcast.org/css/all.css rel="stylesheet">
<link href=https://ubuntusecuritypodcast.org/css/mediaelementplayer.min.css rel="stylesheet">
<style>
    .mejs__overlay-button {
        background-image: url("/img/mejs-controls.svg");
    }
    .mejs__overlay-loading-bg-img {
        background-image: url("/img/mejs-controls.svg");
    }
    .mejs__button > button {
        background-image: url("/img/mejs-controls.svg");
    }
    </style>
<link href=https://ubuntusecuritypodcast.org/css/speed.min.css rel="stylesheet">
<link rel="alternate" type="application/rss+xml" title="Ubuntu Security Podcast" href="https://ubuntusecuritypodcast.org/episode/index.xml"/>

</head>

<body lang="">
<nav class="navbar fixed-top navbar-expand-md navbar-light bg-light">
<div class="container">
<a class="navbar-brand" href="https://ubuntusecuritypodcast.org/">Ubuntu Security Podcast</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div id="navbarSupportedContent" class="navbar-collapse collapse">
      <ul class="navbar-nav mr-auto">
          
          
            
              
                  <li class= "nav-item ">
                  <a href="https://ubuntusecuritypodcast.org/about/" class="nav-link">
                      
                      <span>About</span>
                  </a>
                </li>
              
            
              
                  <li class= "nav-item ">
                  <a href="https://ubuntusecuritypodcast.org/contact/" class="nav-link">
                      
                      <span>Contact</span>
                  </a>
                </li>
              
            
          
        </ul>

      <ul class="navbar-nav ml-auto">
        
        
          <li>
            

  <a class="social-links" href = "https://twitter.com/ubuntu_sec"><i class="fab fa-twitter-square fa-2x"></i></a>


          </li>
        
        
        
        
        
        
        
        
        
        <li>
          

  <a class="social-links" href = "https://fosstodon.org/@ubuntusecurity"><i class="fab fa-mastodon fa-2x"></i></a>


        </li>
        
      </ul>
  </div>
  </div>
  </nav>

<div class="container middle_container">
  

  <div class="row">
    <div class="col">      
      
        <h1>Episode 242</h1>
      <small>Posted on Friday, Nov 29, 2024 


</small></div>
  </div>

  
    <div class="row">
          <div class="col-md-3">
            <img src="https://ubuntusecuritypodcast.org/img/usp_logo_500.png" class="img-fluid episode_image"/>
          </div>
          <div class="col-md-8">
            This week we dive into the details of a number of local privilege escalation
vulnerablities discovered by Qualys in the needrestart package, covering topics
from confused deputies to the inner workings of the /proc filesystem and
responsible disclosure as well.
          </div>
        </div>
    <div class="row">
          <div class="col-md-12 player_row">

          <audio id="player2" style="width: 100%" controls preload="none">
            <source src="https://people.canonical.com/~amurray/USP/USP_E242.mp3" type="audio/mp3">
            </audio>
          </div>
        </div>

  <div class="row">
    <div class="col">
      <h2>Show Notes</h2>
      <h2 id="overview">Overview</h2>
<p>This week we dive into the details of a number of local privilege escalation
vulnerablities discovered by Qualys in the needrestart package, covering topics
from confused deputies to the inner workings of the /proc filesystem and
responsible disclosure as well.</p>
<h2 id="deep-dive-into-needrestart-local-privilege-escalation-vulnerabilities">Deep dive into needrestart local privilege escalation vulnerabilities</h2>
<ul>
<li><a href="https://blog.qualys.com/vulnerabilities-threat-research/2024/11/19/qualys-tru-uncovers-five-local-privilege-escalation-vulnerabilities-in-needrestart">https://blog.qualys.com/vulnerabilities-threat-research/2024/11/19/qualys-tru-uncovers-five-local-privilege-escalation-vulnerabilities-in-needrestart</a></li>
<li><a href="https://www.qualys.com/2024/11/19/needrestart/needrestart.txt">https://www.qualys.com/2024/11/19/needrestart/needrestart.txt</a></li>
<li><a href="https://www.bleepingcomputer.com/news/security/ubuntu-linux-impacted-by-decade-old-needrestart-flaw-that-gives-root/">https://www.bleepingcomputer.com/news/security/ubuntu-linux-impacted-by-decade-old-needrestart-flaw-that-gives-root/</a></li>
<li>Qualys contacted <a href="mailto:security@ubuntu.com">security@ubuntu.com</a> on <!-- raw HTML omitted --><!-- raw HTML omitted -->[2024-10-04 Fri] <!-- raw HTML omitted --><!-- raw HTML omitted --> to notify of 3
different local privilege escalation vulnerablities in needrestart</li>
<li>needrestart is system service, written in Perl, to automatically restart
system services if one of the libraries or the service itself was updated</li>
<li>installed by default on Ubuntu Server since 21.04 - so anyone using 22.04 LTS
(jammy) or 24.04 LTS (noble) would be affected - and is integrated into apt so
that it runs at the end of an apt install/upgrade/remove or via
unattended-upgrades (which again is installed by default to install security
updates automatically every 24 hours)</li>
<li>since it runs via apt it runs as root so if an unprivileged user can influence
it to execute code of their chosing, can achieve local privilege escalation
the next time it runs</li>
<li>Initially described these as:
<ul>
<li>trick needrestart into running the Python interpreter with an attacker controlled PYTHONPATH environment variable</li>
<li>win a race condition with needrestart to trick it into running with attacker
controlled Python interpreter instead of the system-installed one</li>
<li>perl-related vuln in the ScanDeps module where would open a filename
containing a pipe - which in turn causes Perl to execute a shell pipeline
with the filename as input and hence code execution</li>
</ul>
</li>
<li>needrestart is written in Perl so why is Python relevant?
<ul>
<li>basic functionality of needrestart is to look at the shared objects mapped
into memory of each process and match these against newly updated/installed
packages - if it sees that one of the shared objects for a given process got
updated it will then be restarted</li>
<li>back in 2014 introduced support for scanning files of interpreted languages for Java, Perl, Python and Ruby
<ul>
<li>uses <code>/proc/self/exe</code> to first identify the interpreter as say python</li>
<li>then looks at <code>/proc/self/cmdline</code> to determine the primary file being run
by the interpreter and from that looks at <code>import</code> statements to determine
which files are likely being used</li>
<li>uses similar approaches for the other interpreters</li>
</ul>
</li>
</ul>
</li>
<li>Interestingly it seems Qualys discovered this by accident - noticed the
message &ldquo;Scanning processes&hellip;&rdquo; whilst doing and apt upgrade and wondered what
that was - and if they controlled a process, whether they could then influence
the behaviour of it</li>
<li>For PYTHONPATH CVE, needrestart needs to replicate the behaviour of the Python
interpreter when it imports files
<ul>
<li>PYTHONPATH env var allows to specify a
custom path to import from - so needrestart looks this up from
<code>/proc/pid/environ</code> and executes the Python interpreter with this same value
to get it to resolve the imports to files on disk</li>
<li>But the unprivileged user is in control of this environment variable for their
process - classic case of a <a href="https://dl.acm.org/doi/10.1145/54289.871709">Confused Deputy</a> - lower privileged application is
able to trick a higher privileged application into misusing its authority on
the system - so can set their own PYTHONPATH, and since Python will happy load
any <code>__init__.so</code> files from that path, the attacker controlled shared object
is then executed by Python running as root via needrestart</li>
</ul>
</li>
<li>Initially Qualys suggested the Ruby implementation (which uses the <code>RUBYLIB</code>
env var) may also be affected and subsequently confirmed this to be the case</li>
<li>The second aforementioned vuln is also related to Python but instead of the
<code>PYTHONPATH</code> used by the interpreter, is about the interpreter binary itself
<ul>
<li>Before we said needrestart identified a process as using say Python by
looking at its <code>/proc/pid/exe</code> entry - matches this against a regex like
/usr/bin/python - back in 2022 Jakub Wilk discovered a vuln where the regex
was not anchored, so if a process was running via a attacker controlled
interpreter (<code>/home/amurray/usr/bin/python</code>) this would match and
needrestart would execute that interpreter directly as root - CVE-2022-30688</li>
<li>Hoewever, it turns out needrestart reads the processes <code>/proc/pid/exe</code>
twice - once early on when collecting info on all processes, and then a
second time to determine if it is say a Python application - but when
needrestart goes and executes this interpreter to do the PYTHONPATH lookups
etc, it uses the original value that it collected at the start of its run</li>
<li>Classic TOCTOU issue</li>
<li>So a malicious process can run with say its own malicious Python interpreter
at startup, then wait for needrestart to probe that (using say inotify to be
notified when it is accessed) and then quickly exec() the real system Python
interpreter and hence change its <code>/proc/self/exe</code> to trick needrestart -
which will then go and execute its original malicious interpreter binary</li>
</ul>
</li>
<li>Since had found issues in Python and Ruby parts of needrestart, Qualys went
looking at the Perl parts
<ul>
<li>since needrestart is written in Perl though it doesn&rsquo;t have to execute a
Perl interpreter to resolve &ldquo;imports&rdquo; etc</li>
<li>instead uses a Perl library (ScanDeps) which analyses Perl scripts directly</li>
<li>Found this module was vulnerable to a very old Perl foot-gun, Pesky Pipe
(coined in <a href="https://phrack.org/issues/55/7.html#article">1999 by rain.forest.puppy in Phrack</a>)
<ul>
<li>Perl has a feature where you can call <code>open</code> with a string that ends in a
pipe (<code>|</code>) and it will instead execute that string as a shell command</li>
<li>ScanDeps did exactly this - called <code>open</code> on any files that it finds along
the way in its analysis - and since these filenames are controlled by the
unprivileged attacker, can create a file which ends in a pipe character
(e.g. <code>/home/amurray/bin/pwned|</code>) and Perl will then just execute that
script directly</li>
</ul>
</li>
<li>Also found cases in ScanDeps where it would call <code>eval()</code> on contents from
these files as well - directly executing whatever strings found as Perl code</li>
</ul>
</li>
<li>Mark Esler on our team then liased with Qualys and got the upstream
needrestart developer involved to coordinate on writing fixes and disclosing
the issue - first to other distros via the distros mailing list and then
eventually publicly via oss-security</li>
<li>Patches to fix went through a number of revisions before being finalised</li>
<li>To fix these, a number of changes were made:
<ul>
<li>ScanDeps was fixed to use an explicit call to open() to avoid Perl executing
the argument as code and the uses of eval replaced with safer parsing</li>
<li>needrestart removed the use of ScanDeps entirely and instead replaced this
with its own regex based parsing of perl files to look for <code>use</code> directives</li>
<li>needrestart modified to not set PYTHONPATH when running the Python
interpreter and instead look inside the specified PYTHONPATH manually (to
avoid having the Python interpreter possibly load untrusted shared objects
from that path) - similarly for RUBYLIB</li>
<li>needrestart modified to use the original <code>/proc/pid/exe</code> path to match
against when looking for interpreted processes to remove the TOCTOU race</li>
</ul>
</li>
<li>Unfortunately, testing for the patches upstream wasn&rsquo;t complete and a minor
regression was introduced in the original update which caused needrestart to
misidentify processes within a container as being on the host and so would
inadvertently kill them</li>
<li>Sudhakar Verma (who handled the technical side of testing proposed patches
plus preparing and releasing the final updates) liased with upstream to help
get a fix developed and deployed as a regression fix for Ubuntu</li>
<li>Interesting to consider, the info needrestart was using comes from <code>/proc</code>
filesystem - this is a virtual filesystem managed by the kernel, representing
information about processes in userspace</li>
<li>Easy to assume the data it presents is trusted as it is populated by the
kernel - and generally file permissions are read-only for these files - so a
process can&rsquo;t just directly write to them to modify them - BUT these values
all come from the userspace process itself originally
<ul>
<li>perhaps needrestart could look at dropping privileges to those of the
process in question before doing the evaluation as well - although this is
tricky to do correctly - we&rsquo;ve seen bugs in a number of applications which
try and follow this pattern like snap-confine or apport which turn out to
cause security issues as they don&rsquo;t drop privileges completely etc</li>
</ul>
</li>
<li>Ryan Lee is looking to create an AppArmor profile for needrestart to help
confine it to hopefully limit the damage any other similar bugs may cause</li>
</ul>
<h3 id="usn-7117-1-needrestart-and-module-scandeps-vulnerabilities">[<a href="https://ubuntu.com/security/notices/USN-7117-1">USN-7117-1</a>] needrestart and Module::ScanDeps vulnerabilities</h3>
<ul>
<li>5 CVEs addressed in Xenial ESM (16.04 ESM), Bionic ESM (18.04 ESM), Focal (20.04 LTS), Jammy (22.04 LTS), Noble (24.04 LTS), 24.10
<ul>
<li>2 medium priority CVE(s)</li>
<li>3 high priority CVE(s)</li>
</ul>
</li>
</ul>
<h3 id="usn-7117-2-needrestart-regression">[<a href="https://ubuntu.com/security/notices/USN-7117-2">USN-7117-2</a>] needrestart regression</h3>
<ul>
<li>5 CVEs addressed in Xenial ESM (16.04 ESM), Bionic ESM (18.04 ESM), Focal (20.04 LTS), Jammy (22.04 LTS), Noble (24.04 LTS), 24.10
<ul>
<li>2 medium priority CVE(s)</li>
<li>3 high priority CVE(s)</li>
</ul>
</li>
</ul>
<h2 id="get-in-contact">Get in contact</h2>
<ul>
<li><a href="mailto:security@ubuntu.com">security@ubuntu.com</a></li>
<li><a href="https://libera.chat">#ubuntu-security on the Libera.Chat IRC network</a></li>
<li><a href="https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened">ubuntu-hardened mailing list</a></li>
<li><a href="https://discourse.ubuntu.com/c/security">Security section on discourse.ubuntu.com</a></li>
<li><a href="https://fosstodon.org/@ubuntusecurity">@ubuntusecurity@fosstodon.org</a>, <a href="https://twitter.com/ubuntu_sec">@ubuntu_sec on twitter</a></li>
</ul>

    </div>
  </div>



  

  


      <div class="row">
        
        <div class="col-md-12">
          <div id="share"></div>
        </div>
      </div>
      
      
      
      

      <div class="row">
        
        <div class="col-md-12">
          <nav>
            <ul class="pagination">
              
                <li class="page-item">
                  <a href="https://ubuntusecuritypodcast.org/episode-241/" class="page-link">
                    <span aria-hidden="true">&larr;</span>
                    Previous</a>
                </li>
                
              
                <li class="page-item disabled">
                  <a href="#" class="page-link">Next
                    <span aria-hidden="true">&rarr;</span>
                  </a>
                </li>
              
            </ul>
          </nav>
        </div>
      </div>
      
    
</div> 
<div class = "container bottom_container">
  <div class="row">
  <div class="col-md-12">
    <nav class = "navbar navbar-default navbar_footer">
    <ul class="nav navbar-nav navbar-right">
      
        <li>
          <p class = "footer_copyright">Copyright 2018-2024 <a href="https://www.canonical.com/">Canonical</a></p>
        </li>
      
      <li>
        &nbsp;
      </li>
    </ul>
  </nav>

  </div>
</div>
</div>
<script src='https://ubuntusecuritypodcast.org/js/castanet-min.js'></script>
<script>
  $("#share").jsSocials({
      shares: [
    {
      share: "facebook",
      logo: "fab fa-facebook",
    },
    {
      share: "twitter",           
      label: "Tweet",             
      logo: "fab fa-twitter",
      
      
      
      
      
        
          via: "ubuntu_sec", 
        
      
      url: "https:\/\/ubuntusecuritypodcast.org\/episode-242\/",
      text: "Episode 242"
    },
    {
      share: "linkedin",
      logo: "fab fa-linkedin"
    },
    {
      share: "pinterest",
      logo: "fab fa-pinterest"
    }
  ],
  });
</script>

<script>
    $(document).ready(function() {

        $('.transcript').hide();
        $(".hide_transcript").hide();
        $(".hide_transcript").click(function() {
            $(".transcript").hide("fast");
            $(".show_transcript").show();
            $(".hide_transcript").hide();
        });

        $(".show_transcript").click(function() {
            $(".transcript").show(500);
            $(".hide_transcript").show();
            $(".show_transcript").hide();
        });

    });
</script>

<script>
    var player = new MediaElementPlayer('player2', {
        features: ['playpause', 'current', 'progress', 'duration', 'volume', 'speed'],
        defaultSpeed: 1.0,
        
    });
</script>

</body>
</html>

